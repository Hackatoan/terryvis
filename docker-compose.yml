version: "3.9"

services:
  asr:
    build:
      context: .
      dockerfile: Dockerfile.whisper
    environment:
      # Run the ASR service in Vosk mode by default for speed
      - ASR_ENGINE=${ASR_ENGINE:-vosk}
      - VOSK_MODEL=${VOSK_MODEL:-/app/models/vosk-model-small-en-us-0.15}
    ports:
      - "5005:5005"

  bot:
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - asr
    environment:
      # Secrets / runtime values are picked up from the environment or the .env file.
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - CLIPS_CHANNEL_ID=${CLIPS_CHANNEL_ID}
      - PORT=${PORT:-3000}
      # ASR configuration: choose 'vosk' (default)
      - ASR_ENGINE=${ASR_ENGINE:-vosk}
      # When using Vosk, point to the model directory available in the container
      - VOSK_MODEL=${VOSK_MODEL:-/app/models/vosk-model-small-en-us-0.15}
      # URL to the ASR server (internal docker service name 'asr')
      - ASR_URL=${ASR_URL:-http://asr:5005}
      # Backwards-compatible name used in some configs
      - WHISPER_URL=${WHISPER_URL:-http://asr:5005}
      # Optional: public base URL where the web UI is reachable (used for clip links)
      - CLIPS_BASE_URL=${CLIPS_BASE_URL:-http://localhost:3000}
    ports:
      - "3000:3000"
    # Mount clips folder for persistence if desired
    volumes:
      - ./public/clips:/app/public/clips
